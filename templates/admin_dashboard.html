<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Humongous AI Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { background:#111; color:#fff; font-family:Poppins,sans-serif; }
.card { background:#1c1c1c; border:none; border-radius:1rem; padding:1.5rem; margin-bottom:1.2rem; }
h2 { color:#0ff; }
.table-dark th, .table-dark td { color:#fff; }
.btn-refresh { background:#007bff; color:white; border:none; padding:0.6rem 1.2rem; border-radius:0.5rem; }
canvas { max-height:320px; }
</style>
</head>
<body>
<div class="container py-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2>Humongous AI Dashboard</h2>
      <p>Analytics for Akilan S R</p>
    </div>
    <button class="btn-refresh" onclick="loadStats()">ðŸ”„ Refresh</button>
  </div>

  <div class="row text-center mb-4">
    <div class="col-md-4"><div class="card"><h5>Total Messages</h5><h3 id="totalMessages">0</h3></div></div>
    <div class="col-md-4"><div class="card"><h5>Unique Sessions</h5><h3 id="uniqueSessions">0</h3></div></div>
    <div class="col-md-4"><div class="card"><h5>Fallback Rate</h5><h3 id="fallbackRate">0%</h3></div></div>
  </div>

  <div class="card">
    <h5>Messages Over Time</h5>
    <canvas id="msgChart"></canvas>
  </div>

  <div class="card">
    <h5>All Chat Logs</h5>
    <table class="table table-dark table-striped mt-3">
      <thead>
        <tr><th>Timestamp</th><th>Sender</th><th>Message</th><th>Intent</th></tr>
      </thead>
      <tbody id="logs"><tr><td colspan="4">Loading...</td></tr></tbody>
    </table>
  </div>
</div>

<script>
async function loadStats() {
  try {
    const res = await fetch("/api/admin/stats");
    if (!res.ok) throw new Error("Failed to fetch stats");
    const data = await res.json();

    document.getElementById("totalMessages").textContent = data.total_messages;
    document.getElementById("uniqueSessions").textContent = data.unique_sessions;
    document.getElementById("fallbackRate").textContent = data.fallback_rate + "%";

    // Table
    const tbody = document.getElementById("logs");
    tbody.innerHTML = "";
    data.recent_logs.forEach(l => {
      const row = `<tr>
        <td>${l.timestamp}</td>
        <td>${l.sender}</td>
        <td>${l.message}</td>
        <td>${l.intent || "-"}</td>
      </tr>`;
      tbody.innerHTML += row;
    });

    // Chart
    const countByDate = {};
    data.recent_logs.forEach(l => {
      const date = l.timestamp?.split(" ")[0];
      countByDate[date] = (countByDate[date] || 0) + 1;
    });
    const labels = Object.keys(countByDate).reverse();
    const counts = Object.values(countByDate).reverse();

    const ctx = document.getElementById("msgChart").getContext("2d");
    if (window.msgChart) window.msgChart.destroy();
    window.msgChart = new Chart(ctx, {
      type: "line",
      data: { labels, datasets: [{
        label: "Messages per Day",
        data: counts,
        borderColor: "#0ff",
        backgroundColor: "rgba(0,255,255,0.2)",
        tension: 0.3,
        fill: true
      }]},
      options: { scales: { y: { beginAtZero: true } } }
    });

  } catch (err) {
    console.error(err);
    alert("Failed to load dashboard data");
  }
}

loadStats();
</script>
</body>
</html>